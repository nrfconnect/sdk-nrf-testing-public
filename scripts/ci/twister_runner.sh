#!/usr/bin/env bash
set -euo pipefail

EXTRA_FLAGS=""
NRFUTIL=""
OS="$(uname)"
TOOLCHAIN_BUNDLE_ID=$(./nrf/scripts/print_toolchain_checksum.sh)

echo "Detected OS: $OS"
echo "Toolchain bundle: $TOOLCHAIN_BUNDLE_ID"
echo "Using twister arguments: $@"

# Detect OS and set OS-specific commands
case "$(uname -s)" in
    MINGW*)
        EXTRA_FLAGS="--short-build-path"
        export PYTHONUTF8=1
        NRFUTIL="../nrfutil.exe sdk-manager toolchain launch --toolchain-bundle-id $TOOLCHAIN_BUNDLE_ID -- python zephyr\\scripts\\twister"
        ;;
    Linux*)
        NRFUTIL="../nrfutil sdk-manager toolchain launch --toolchain-bundle-id $TOOLCHAIN_BUNDLE_ID -- python zephyr/scripts/twister"
        ;;
    Darwin*)
        EXTRA_FLAGS=""
        NRFUTIL="sudo ../nrfutil sdk-manager toolchain launch --toolchain-bundle-id $TOOLCHAIN_BUNDLE_ID -- python zephyr/scripts/twister"
        ;;
    *)
        echo "Unsupported OS: $(uname -s)"
        exit 1
        ;;
esac

set -x
#$NRFUTIL --ninja --inline-logs --verbose --overflow-as-errors --enable-size-report --no-detailed-test-id \
#  --retry-failed 2 --shuffle-tests-seed 1234 \
#  --quarantine-list nrf/scripts/quarantine.yaml \
#  --subset "$SUBSET" --outdir "$OUTDIR" --report-dir results_samples \
#  -T nrf/samples -T nrf/applications -T nrf/tests $EXTRA_FLAGS

$NRFUTIL "$@" $EXTRA_FLAGS
